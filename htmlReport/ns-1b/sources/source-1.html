


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PostgresVaccineManagementService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">cesim.individuals.infrastructure.services.vaccine</a>
</div>

<h1>Coverage Summary for Class: PostgresVaccineManagementService (cesim.individuals.infrastructure.services.vaccine)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PostgresVaccineManagementService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package cesim.individuals.infrastructure.services.vaccine;
&nbsp;
&nbsp;import cesim.individuals.domain.entities.Immunization;
&nbsp;import cesim.individuals.domain.entities.ImmunizationRecommendation;
&nbsp;import cesim.individuals.domain.entities.Patient;
&nbsp;import cesim.individuals.domain.entities.vaccine.VaccineReportDTO;
&nbsp;import cesim.individuals.domain.usecases.vacinne.depenencies.VaccineManagementService;
&nbsp;import cesim.individuals.infrastructure.repository.ImmunizationRecommendationRepository;
&nbsp;import cesim.individuals.infrastructure.repository.ImmunizationRepository;
&nbsp;import cesim.individuals.infrastructure.repository.PatientRepository;
&nbsp;import cesim.individuals.infrastructure.repository.models.ImmunizationModel;
&nbsp;import cesim.individuals.infrastructure.repository.models.ImmunizationRecommendationModel;
&nbsp;import cesim.individuals.infrastructure.repository.models.PatientModel;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.time.LocalDate;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Service
<b class="nc">&nbsp;@RequiredArgsConstructor</b>
&nbsp;public class PostgresVaccineManagementService implements VaccineManagementService {
&nbsp;
&nbsp;  private final ImmunizationRepository immunizationRepository;
&nbsp;  private final PatientRepository patientRepository;
&nbsp;  private final ImmunizationRecommendationRepository recommendationRepository;
&nbsp;
&nbsp;  @Override
&nbsp;  public VaccineReportDTO generateVaccineReport(LocalDate reportDate) {
<b class="nc">&nbsp;    List&lt;ImmunizationModel&gt; allImmunizations = immunizationRepository.findAll();</b>
<b class="nc">&nbsp;    Map&lt;String, List&lt;Immunization&gt;&gt; immunizationsByPatient = allImmunizations.stream()</b>
<b class="nc">&nbsp;            .collect(Collectors.groupingBy(</b>
<b class="nc">&nbsp;                    imm -&gt; imm.getResource().patient().reference().split(&quot;/&quot;)[1],</b>
<b class="nc">&nbsp;                    Collectors.mapping(ImmunizationModel::getResource, Collectors.toList())</b>
&nbsp;            ));
&nbsp;
<b class="nc">&nbsp;    List&lt;PatientModel&gt; patientModels = patientRepository.findAll();</b>
&nbsp;
<b class="nc">&nbsp;    List&lt;VaccineReportDTO.PatientVaccineStatus&gt; statuses = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    List&lt;VaccineReportDTO.UpcomingDoseAlert&gt; alerts = new ArrayList&lt;&gt;();</b>
&nbsp;    List&lt;ImmunizationRecommendationModel&gt; recommendationModels;
&nbsp;
&nbsp;    try {
<b class="nc">&nbsp;     recommendationModels = recommendationRepository.findAll();</b>
&nbsp;
&nbsp;    } catch (Exception e) {
<b class="nc">&nbsp;      e.printStackTrace();</b>
<b class="nc">&nbsp;      throw new RuntimeException(e);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    for (PatientModel pm : patientModels) {</b>
<b class="nc">&nbsp;      Patient patient = pm.getResource();</b>
<b class="nc">&nbsp;      String patientId = pm.getId();</b>
<b class="nc">&nbsp;      LocalDate birthDate = patient.birthDate();</b>
&nbsp;
<b class="nc">&nbsp;      if (birthDate == null) continue;</b>
&nbsp;
<b class="nc">&nbsp;      List&lt;Immunization&gt; patientImmunizations = immunizationsByPatient.getOrDefault(patientId, List.of());</b>
&nbsp;
<b class="nc">&nbsp;      for (ImmunizationRecommendationModel rec : recommendationModels) {</b>
<b class="nc">&nbsp;        if (!rec.getResource().patient().reference().endsWith(patientId)) continue;</b>
&nbsp;
<b class="nc">&nbsp;        for (ImmunizationRecommendation.Recommendation recommendation : rec.getResource().recommendation()) {</b>
<b class="nc">&nbsp;          String vaccineId = recommendation.vaccineCode().coding().get(0).code();</b>
<b class="nc">&nbsp;          String vaccineName = recommendation.vaccineCode().coding().get(0).display();</b>
<b class="nc">&nbsp;          int appliedDoses = countAppliedDoses(patientImmunizations, vaccineId);</b>
<b class="nc">&nbsp;          int nextDoseNumber = recommendation.doseNumber();</b>
<b class="nc">&nbsp;          LocalDate nextDoseDate = recommendation.dateCriterion().get(0).value().toLocalDate();</b>
&nbsp;
<b class="nc">&nbsp;          statuses.add(new VaccineReportDTO.PatientVaccineStatus(</b>
&nbsp;                  patientId,
<b class="nc">&nbsp;                  patient.name().get(0).given().get(0) + &quot; &quot; + patient.name().get(0).family(),</b>
&nbsp;                  vaccineName,
&nbsp;                  appliedDoses,
&nbsp;                  nextDoseNumber,
&nbsp;                  nextDoseDate
&nbsp;          ));
&nbsp;
<b class="nc">&nbsp;          if (nextDoseDate.isBefore(reportDate.plusWeeks(2))) {</b>
<b class="nc">&nbsp;            alerts.add(new VaccineReportDTO.UpcomingDoseAlert(</b>
&nbsp;                    patientId,
<b class="nc">&nbsp;                    patient.name().get(0).given().get(0) + &quot; &quot; + patient.name().get(0).family(),</b>
&nbsp;                    vaccineName,
&nbsp;                    nextDoseNumber,
&nbsp;                    nextDoseDate
&nbsp;            ));
&nbsp;          }
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    return new VaccineReportDTO(statuses, alerts);</b>
&nbsp;  }
&nbsp;
&nbsp;  private int countAppliedDoses(List&lt;Immunization&gt; immunizations, String vaccineId) {
<b class="nc">&nbsp;    return (int) immunizations.stream()</b>
<b class="nc">&nbsp;            .filter(imm -&gt; vaccineId.equals(imm.vaccineCode().coding().get(0).code())).count();</b>
&nbsp;  }
&nbsp;
&nbsp;  public List&lt;ImmunizationRecommendation&gt; getVaccineRecommendations() {
<b class="nc">&nbsp;    List&lt;ImmunizationRecommendation&gt; vaccineRecommendations =</b>
<b class="nc">&nbsp;            recommendationRepository.findAll().stream().</b>
<b class="nc">&nbsp;                    map(ImmunizationRecommendationModel::getResource)</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
<b class="nc">&nbsp;    return vaccineRecommendations;</b>
&nbsp;  }
&nbsp;}
&nbsp;
&nbsp;//@Service
&nbsp;//@RequiredArgsConstructor
&nbsp;//public class PostgresVaccineManagementService implements VaccineManagementService {
&nbsp;//
&nbsp;//  private final ImmunizationRepository immunizationRepository;
&nbsp;//  private final PatientRepository patientRepository;
&nbsp;//  private final OfficialVaccineCalendar officialVaccineCalendar;
&nbsp;//
&nbsp;//  @Override
&nbsp;//  public VaccineReportDTO generateVaccineReport(LocalDate reportDate) {
&nbsp;//    List&lt;ImmunizationModel&gt; allImmunizations = immunizationRepository.findAll();
&nbsp;//    Map&lt;String, List&lt;Immunization&gt;&gt; immunizationsByPatient = allImmunizations.stream()
&nbsp;//            .collect(Collectors.groupingBy(
&nbsp;//                    imm -&gt; imm.getResource().patient().reference().split(&quot;/&quot;)[1],
&nbsp;//                    Collectors.mapping(ImmunizationModel::getResource, Collectors.toList())
&nbsp;//            ));
&nbsp;//
&nbsp;//    List&lt;PatientModel&gt; patientModels = patientRepository.findAll();
&nbsp;//
&nbsp;//    List&lt;VaccineReportDTO.PatientVaccineStatus&gt; statuses = new ArrayList&lt;&gt;();
&nbsp;//    List&lt;VaccineReportDTO.UpcomingDoseAlert&gt; alerts = new ArrayList&lt;&gt;();
&nbsp;//
&nbsp;//    for(PatientModel pm: patientModels){
&nbsp;//      Patient patient = pm.getResource();
&nbsp;//      String patientId = pm.getId();
&nbsp;//      LocalDate birthDate = pm.getResource().birthDate();
&nbsp;//
&nbsp;//      if(birthDate == null) continue;
&nbsp;//
&nbsp;//      List&lt;Immunization&gt; patientImmunizations = immunizationsByPatient.getOrDefault(patientId, List.of());
&nbsp;//
&nbsp;//      for (VaccineScheduleDTO vaccine: officialVaccineCalendar.getSchedules()){
&nbsp;//        int appliedDoses = countAppliedDoses(patientImmunizations, vaccine.vaccineId());
&nbsp;//
&nbsp;//        VaccineScheduleDTO.DoseSchedule nextDose = findNextDose(vaccine, appliedDoses, birthDate, reportDate);
&nbsp;//
&nbsp;//        if(nextDose != null){
&nbsp;//          LocalDate nextDoseDate = calculateNextDoseDate(birthDate, nextDose, reportDate);
&nbsp;//
&nbsp;//          statuses.add(new VaccineReportDTO.PatientVaccineStatus(
&nbsp;//                  patientId,
&nbsp;//                  patient.name().get(0).given().get(0) + &quot; &quot; + patient.name().get(0).family(),
&nbsp;//                  vaccine.displayName(),
&nbsp;//                  appliedDoses,
&nbsp;//                  nextDose.doseNumber(),
&nbsp;//                  nextDoseDate
&nbsp;//          ));
&nbsp;//
&nbsp;//          if(nextDoseDate.isBefore(reportDate.plusWeeks(2))) {
&nbsp;//            alerts.add(new VaccineReportDTO.UpcomingDoseAlert(
&nbsp;//                    patientId,
&nbsp;//                    patient.name().get(0).given().get(0) + &quot; &quot; + patient.name().get(0).family(),
&nbsp;//                    vaccine.displayName(),
&nbsp;//                    nextDose.doseNumber(),
&nbsp;//                    nextDoseDate
&nbsp;//            ));
&nbsp;//          }
&nbsp;//        }
&nbsp;//      }
&nbsp;//
&nbsp;//    }
&nbsp;//      return new VaccineReportDTO(statuses, alerts);
&nbsp;//  }
&nbsp;//
&nbsp;//
&nbsp;//  private int countAppliedDoses(List&lt;Immunization&gt; immunizations, String vaccineId){
&nbsp;//    return (int) immunizations.stream()
&nbsp;//            .filter(imm -&gt; vaccineId.equals(imm.vaccineCode()
&nbsp;//                    .coding().get(0).code())).count();
&nbsp;//  }
&nbsp;//
&nbsp;//  private VaccineScheduleDTO.DoseSchedule findNextDose(
&nbsp;//          VaccineScheduleDTO vaccine, int appliedDoses, LocalDate birthDate, LocalDate reportDate){
&nbsp;//    List&lt;VaccineScheduleDTO.DoseSchedule&gt; doses = vaccine.doseSchedules();
&nbsp;//
&nbsp;//    if(appliedDoses &gt;= doses.size()) return null;
&nbsp;//
&nbsp;//    VaccineScheduleDTO.DoseSchedule nextDose = doses.get(appliedDoses);
&nbsp;//    LocalDate minDate = birthDate.plus(nextDose.minAge());
&nbsp;//
&nbsp;//    return minDate.isBefore(reportDate) || minDate.isEqual(reportDate) ? nextDose : null;
&nbsp;//  }
&nbsp;//
&nbsp;//  private LocalDate calculateNextDoseDate(LocalDate birthDate, VaccineScheduleDTO.DoseSchedule dose, LocalDate reportDate){
&nbsp;//    LocalDate minDate  = birthDate.plus(dose.minAge());
&nbsp;//    return minDate.isAfter(reportDate) ? minDate : reportDate.plus(dose.recommendedInterval());
&nbsp;//  }
&nbsp;//
&nbsp;//}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-15 01:28</div>
</div>
</body>
</html>
